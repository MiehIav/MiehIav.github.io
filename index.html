<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>War Map Maker</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: sans-serif;
        overflow: hidden;
      }
      #toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #333;
        color: #fff;
        padding: 10px;
        z-index: 100;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      #toolbar button,
      #toolbar input[type="file"] {
        padding: 6px 10px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #toolbar button:hover {
        background: #555;
      }
      #canvas-container {
        position: absolute;
        top: 50px; /* height of toolbar */
        left: 0;
        right: 0;
        bottom: 0;
        background: #ddd;
      }
      /* Optional: style for file input to hide the default button */
      #bgInput {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="toolbar">
      <button id="addUnitBtn" title="Add a unit (red circle)">Add Unit</button>
      <button id="addTextBtn" title="Add editable text">Add Text</button>
      <button id="setBgBtn" title="Set a background image">Set Background</button>
      <input type="file" id="bgInput" accept="image/*" />
      <button id="toggleGridBtn" title="Toggle grid overlay">Toggle Grid</button>
      <button id="zoomInBtn" title="Zoom in">Zoom In</button>
      <button id="zoomOutBtn" title="Zoom out">Zoom Out</button>
      <button id="resetViewBtn" title="Reset pan/zoom">Reset View</button>
      <button id="exportBtn" title="Download your map as PNG">Export Map</button>
      <button id="clearBtn" title="Clear the canvas">Clear Map</button>
    </div>
    <div id="canvas-container">
      <canvas id="c"></canvas>
    </div>

    <!-- Fabric.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
    <script>
      // Initialize Fabric.js canvas
      const canvasElem = document.getElementById("c");
      const container = document.getElementById("canvas-container");
      canvasElem.width = container.clientWidth;
      canvasElem.height = container.clientHeight;
      const canvas = new fabric.Canvas("c", {
        preserveObjectStacking: true,
        selection: true,
      });

      // Keep canvas size in sync with container
      window.addEventListener("resize", () => {
        canvas.setWidth(container.clientWidth);
        canvas.setHeight(container.clientHeight);
        drawGrid();
        canvas.renderAll();
      });

      // --- Grid Functionality ---
      let gridVisible = false;
      const gridSize = 50;
      function drawGrid() {
        // Remove any existing grid lines
        canvas.getObjects("line").forEach((obj) => {
          if (obj.isGrid) canvas.remove(obj);
        });
        if (!gridVisible) return;

        const width = canvas.getWidth();
        const height = canvas.getHeight();
        // Draw vertical lines
        for (let i = 0; i <= width / gridSize; i++) {
          const line = new fabric.Line(
            [i * gridSize, 0, i * gridSize, height],
            {
              stroke: "#ccc",
              selectable: false,
              evented: false,
            }
          );
          line.isGrid = true;
          canvas.add(line);
          line.sendToBack();
        }
        // Draw horizontal lines
        for (let i = 0; i <= height / gridSize; i++) {
          const line = new fabric.Line(
            [0, i * gridSize, width, i * gridSize],
            {
              stroke: "#ccc",
              selectable: false,
              evented: false,
            }
          );
          line.isGrid = true;
          canvas.add(line);
          line.sendToBack();
        }
      }

      document
        .getElementById("toggleGridBtn")
        .addEventListener("click", () => {
          gridVisible = !gridVisible;
          drawGrid();
          canvas.renderAll();
        });

      // --- Toolbar Buttons ---

      // Add Unit: creates a red circle (can represent a unit)
      document.getElementById("addUnitBtn").addEventListener("click", () => {
        const circle = new fabric.Circle({
          left: 100,
          top: 100,
          radius: 20,
          fill: "red",
          stroke: "black",
          strokeWidth: 2,
          hasControls: true,
          hasBorders: true,
        });
        canvas.add(circle);
      });

      // Add Text: creates an editable text field
      document.getElementById("addTextBtn").addEventListener("click", () => {
        const text = new fabric.IText("New Text", {
          left: 150,
          top: 150,
          fontSize: 20,
          fill: "black",
        });
        canvas.add(text);
        canvas.setActiveObject(text);
        text.enterEditing();
      });

      // Set Background: allow the user to upload an image
      document.getElementById("setBgBtn").addEventListener("click", () => {
        document.getElementById("bgInput").click();
      });
      document.getElementById("bgInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (f) {
          const data = f.target.result;
          fabric.Image.fromURL(data, (img) => {
            // Scale background to fit canvas
            img.scaleToWidth(canvas.getWidth());
            img.scaleToHeight(canvas.getHeight());
            canvas.setBackgroundImage(
              img,
              canvas.renderAll.bind(canvas),
              { originX: "left", originY: "top" }
            );
          });
        };
        reader.readAsDataURL(file);
      });

      // Zoom In / Zoom Out / Reset View
      document.getElementById("zoomInBtn").addEventListener("click", () => {
        const zoom = canvas.getZoom() * 1.1;
        canvas.setZoom(zoom);
      });
      document.getElementById("zoomOutBtn").addEventListener("click", () => {
        const zoom = canvas.getZoom() / 1.1;
        canvas.setZoom(zoom);
      });
      document.getElementById("resetViewBtn").addEventListener("click", () => {
        canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
        canvas.setZoom(1);
      });

      // Export the map as a PNG image
      document.getElementById("exportBtn").addEventListener("click", () => {
        const dataURL = canvas.toDataURL({
          format: "png",
          quality: 1,
        });
        const link = document.createElement("a");
        link.href = dataURL;
        link.download = "war_map.png";
        link.click();
      });

      // Clear the canvas (with confirmation)
      document.getElementById("clearBtn").addEventListener("click", () => {
        if (confirm("Clear the map? This cannot be undone.")) {
          canvas.clear();
          canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
          if (gridVisible) drawGrid();
        }
      });

      // --- Panning (click & drag on empty space) ---
      let isPanning = false;
      canvas.on("mouse:down", function (opt) {
        // If an object was clicked, donâ€™t pan.
        if (opt.target) return;
        isPanning = true;
        canvas.selection = false;
        canvas.defaultCursor = "move";
        const evt = opt.e;
        this.lastPosX = evt.clientX;
        this.lastPosY = evt.clientY;
      });
      canvas.on("mouse:move", function (opt) {
        if (isPanning && opt && opt.e) {
          const e = opt.e;
          const vpt = canvas.viewportTransform;
          vpt[4] += e.clientX - this.lastPosX;
          vpt[5] += e.clientY - this.lastPosY;
          canvas.requestRenderAll();
          this.lastPosX = e.clientX;
          this.lastPosY = e.clientY;
        }
      });
      canvas.on("mouse:up", function (opt) {
        isPanning = false;
        canvas.selection = true;
        canvas.defaultCursor = "default";
      });

      // Initial grid drawing (if toggled on)
      drawGrid();
    </script>
  </body>
</html>
